<?php

use Drupal\Core\Form\FormStateInterface;

function upload_test_form_alter(array &$form, FormStateInterface $form_state, string $form_id) {
  
  if ($form_id == 'upload_test_form') {
    
    $form['#submit'][] = 'upload_test_upload_test_form_submit';
  }
}

function upload_test_upload_test_form_submit(array &$form, FormStateInterface $form_state) {
  // Get the form values.
  $form_values = $form_state->getValues();

  // Do something with the form data.  For example, log it.
  \Drupal::logger('upload_test')->notice('Form data: @data', [
    'data' => print_r($form_values, TRUE),
  ]);

  
  $csv_fid = $form_state->getValue('csv_file')[0]; // Get the file ID.
  $image_fids = $form_state->getValue('image_files');
  
  $csv_file = \Drupal\file\Entity\File::load($csv_fid);
    if (!$csv_file) {
      $this->messenger()->addError($this->t('Failed to load the CSV file.'));
      return;
    }

    // Process the CSV file (example: read the first line).
    $csv_uri = $csv_file->getFileUri();
    $handle = fopen($csv_uri, 'r');
    $csv_data = [];
    if ($handle) {
      $csv_data = fgetcsv($handle); // Get the first line of the CSV.
      fclose($handle);
      if ($csv_data) {
        $this->messenger()->addMessage($this->t('First line of CSV: @data', ['@data' => implode(', ', $csv_data)]));
      }
    }
    else {
      $this->messenger()->addError($this->t('Could not open the csv file.'));
      return;
    }

    $header = fgetcsv($handle); // Get the header row.
    if ($header === FALSE) {
      $this->messenger()->addError($this->t('Could not read the CSV header.'));
      fclose($handle);
      return;
    }

    $image_uris = [];
    $images_data = [];
    // Load and process the image files.
    foreach ($image_fids as $image_fid) {
      $image_file = \Drupal\file\Entity\File::load($image_fid);
      if ($image_file) {
        $image_uri = $image_file->getFileUri();
        $image_uris[] = $image_uri;
        $images_data[] = [
          'uri' => $image_uri,
          'alt' => $image_file->getFilename(), // You might want a separate field for alt text.
        ];
      }
    }
    if (count($image_uris) > 0) {
      $this->messenger()->addMessage($this->t('Uploaded images: @images', ['@images' => implode(', ', $image_uris)]));
    }


    $node = Node::create([
      'type' => 'valkyrie_upload',
      'field_csv_data' => serialize($csv_data), // Store the CSV data.  Consider creating a dedicated field.
      'field_image_files' => $images_data, // Store the image file information.  Adjust field name as needed.
    ]);


    $node->save();

    // Set a success message.
    $this->messenger()->addMessage($this->t('Node created successfully.'));

    $this->loggerFactory->get('my_node_creator')->notice('Node created');


    //Please actually work
    $nodes_created = 0;
    while (($row = fgetcsv($handle)) !== FALSE) {
      // Combine header and row data.
      $data = array_combine($header, $row);
       if ($data) {
        // Create a new node for each row.
        $anomaly_location = $data['lat'].", ".$data['lon'];
        $anomaly_status = $data['status'];
        $anomaly_type = $data['type'];

        $anomaly_node = Node::create([
          'type' => 'anomaly',
          'field_anomaly_location' => $anomaly_location,
          'field_qc_status' => $anomaly_status,
          'field_anomaly_type' => $anomaly_type,
          
        ]);

        // Save the node.
        $anomaly_node->save();

        $anomaly_history_date = $data['anomDate'];
        $anomaly_history_photos = $data['pics'];

        $anomaly_history_node = Node::create([
          'type' => 'anomaly_history',
          'field_anomaly' => $anomaly_node,
          'field_date' => $anomaly_history_date,
          'field_patrol_photos' => $anomaly_history_photos,
          
        ]);

        // Save the node.
        $anomaly_history_node->save();

        $nodes_created++;
       }
    }
    fclose($handle);


    $this->messenger()->addMessage($this->t('@count nodes created successfully.', ['@count' => $nodes_created]));

    $this->loggerFactory->get('my_node_creator')->notice('@count nodes created from CSV.', ['@count' => $nodes_created]);
    // Redirect to the node's view page.
    $form_state->setRedirect('entity.node.canonical', ['node' => $node->id()]); 
}